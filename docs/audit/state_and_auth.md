# Состояние и аутентификация

## Управление состоянием

### Основные подходы

1. **React Query (TanStack Query) 5.85.5** - основной инструмент для серверного состояния
2. **Context API** - для глобального состояния приложения
3. **Локальный state** - для UI состояния компонентов
4. **React Hook Form 7.48.2** - для управления формами

## Аутентификация

### AuthProvider (`app/providers/AuthProvider.tsx`)

**Функционал**:
- Управление состоянием пользователя
- Автоматическая проверка токенов при инициализации
- Refresh token механизм
- Логин/регистрация/логаут

**Особенности**:
- Токены хранятся в `localStorage`
- Автоматический refresh при 401 ошибке
- Маппинг данных пользователя к единому формату
- Обработка ошибок аутентификации

**Проблемы**:
- **Синтаксическая ошибка** в `login` функции (строка 115-147)
- Дублирование логики refresh в AuthProvider и API interceptor

### API Interceptor (`shared/api.ts`)

**Функционал**:
- Автоматическое добавление Bearer токена к запросам
- Обработка 401 ошибок с автоматическим refresh
- Редирект на `/login` при неудачном refresh

**Особенности**:
- Использует Axios interceptors
- Автоматическое обновление заголовков после refresh
- Предотвращение бесконечных циклов с `_retry` флагом

## React Query конфигурация

### QueryClient настройки (`index.tsx`)

```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      retry: 1,
      staleTime: 5 * 60 * 1000, // 5 minutes
    },
  },
});
```

### Query Keys структура

Все хуки используют структурированные query keys:

```typescript
// Workspaces
export const workspaceKeys = {
  all: ['workspaces'] as const,
  lists: () => [...workspaceKeys.all, 'list'] as const,
  detail: (id: string) => [...workspaceKeys.details(), id] as const,
  members: (id: string) => [...workspaceKeys.detail(id), 'members'] as const,
  // ...
};

// Notes
export const notesKeys = {
  all: ['notes'] as const,
  pages: () => [...notesKeys.all, 'pages'] as const,
  page: (id: string) => [...notesKeys.pages(), id] as const,
  // ...
};
```

## Хуки для серверного состояния

### Workspaces (`shared/hooks/useWorkspaces.ts`)

**Функционал**:
- CRUD операции с workspace
- Управление участниками
- Приглашения пользователей
- Настройки workspace
- Аналитика

**Особенности**:
- Оптимистичные обновления
- Инвалидация связанных запросов
- Toast уведомления
- Кеширование на 5 минут

### Notes (`shared/hooks/useNotes.ts`)

**Функционал**:
- CRUD операции со страницами
- Управление тегами
- Поиск страниц
- Версионирование
- Шаринг страниц

**Особенности**:
- Поддержка иерархии страниц
- Поиск с дебаунсом (2+ символа)
- Кеширование на 5 минут
- Оптимистичные обновления

### Databases (`shared/hooks/useDatabases.ts`)

**Функционал**:
- CRUD операции с базами данных
- Управление свойствами
- Управление записями
- Различные представления
- Импорт/экспорт

**Особенности**:
- Поддержка пагинации
- Placeholder data для плавных переходов
- Bulk операции
- Кеширование на 5 минут

### Tasks (`shared/hooks/useTasks.ts`)

**Функционал**:
- CRUD операции с досками задач
- Управление колонками
- CRUD операции с задачами
- Фильтрация и сортировка

**Особенности**:
- Поддержка различных статусов
- Приоритеты задач
- Назначение исполнителей
- Кеширование на 2 минуты

## Локальное состояние

### UI состояние
- Модальные окна (useState)
- Формы (React Hook Form)
- Drawer/SidePanel (кастомные хуки)
- Темы (ThemeProvider)

### Кастомные хуки

#### useDrawer (`shared/hooks/useDrawer.ts`)
- Управление выдвижными панелями
- URL параметры для состояния
- Callback функции

#### useSidePanel (`shared/hooks/useSidePanel.ts`)
- Управление боковыми панелями
- Типизированные данные
- Состояние открыто/закрыто

#### useDebounce (`shared/hooks/useDebounce.ts`)
- Дебаунс для поиска
- Оптимизация API вызовов

## Хранение данных

### Токены аутентификации
- **Место**: `localStorage`
- **Ключи**: `access_token`, `refresh_token`
- **Проблема**: Небезопасно для XSS атак

### Кеш React Query
- **Место**: Память браузера
- **Настройки**: 5 минут staleTime
- **Инвалидация**: Автоматическая при мутациях

### Пользовательские данные
- **Место**: React state (AuthProvider)
- **Синхронизация**: При каждом запросе к `/auth/me/`

## Проблемы и риски

### 1. Безопасность
- **XSS уязвимость**: Токены в localStorage
- **Рекомендация**: Использовать httpOnly cookies

### 2. Дублирование логики
- **Refresh token**: Реализован в AuthProvider и API interceptor
- **Рекомендация**: Оставить только в interceptor

### 3. Синтаксические ошибки
- **AuthProvider**: Ошибка в функции login (строки 115-147)
- **Рекомендация**: Исправить синтаксис

### 4. Отсутствие обработки ошибок
- **Сетевые ошибки**: Не все случаи обработаны
- **Рекомендация**: Добавить глобальный error boundary

### 5. Производительность
- **Избыточные запросы**: Нет дебаунса для некоторых операций
- **Рекомендация**: Добавить дебаунс для всех поисковых запросов

## Рекомендации по улучшению

### 1. Безопасность
```typescript
// Использовать httpOnly cookies вместо localStorage
// Настроить CORS и CSP заголовки
// Добавить CSRF защиту
```

### 2. Упрощение архитектуры
```typescript
// Убрать дублирование refresh логики
// Оставить только в API interceptor
// Упростить AuthProvider
```

### 3. Обработка ошибок
```typescript
// Добавить глобальный error boundary
// Улучшить обработку сетевых ошибок
// Добавить retry логику для критичных запросов
```

### 4. Производительность
```typescript
// Добавить виртуализацию для больших списков
// Оптимизировать query keys
// Добавить prefetching для часто используемых данных
```

## Состояние реализации

| Компонент | Статус | Проблемы |
|-----------|--------|----------|
| AuthProvider | ⚠️ Частично | Синтаксические ошибки |
| API Interceptor | ✅ Готов | - |
| React Query | ✅ Готов | - |
| Workspaces Hooks | ✅ Готов | - |
| Notes Hooks | ✅ Готов | - |
| Databases Hooks | ✅ Готов | - |
| Tasks Hooks | ✅ Готов | - |
| Custom Hooks | ✅ Готов | - |

**Общая оценка**: 87% готовности (7 из 8 компонентов с проблемами)
